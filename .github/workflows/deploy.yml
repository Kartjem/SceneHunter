# Имя рабочего процесса
name: Deploy to Firebase Hosting on Push to Main

# Условие запуска: при любом пуше в ветку 'main'
on:
  push:
    branches:
      - main

# Задачи, которые нужно выполнить
jobs:
  build_and_deploy:
    runs-on: ubuntu-latest
    # VVV --- ВАЖНО: Добавляем права для получения токена аутентификации --- VVV
    permissions:
      contents: 'read'
      id-token: 'write'

    steps:
      # 1. Клонируем репозиторий
      - name: Checkout Repository
        uses: actions/checkout@v4

      # 2. Аутентифицируемся в Google Cloud без ключа
      - name: Authenticate to Google Cloud
        uses: 'google-github-actions/auth@v2'
        with:
          # VVV --- ИЗМЕНЕНИЕ ЗДЕСЬ: Вставлен правильный номер проекта --- VVV
          workload_identity_provider: 'projects/233532216462/locations/global/workloadIdentityPools/github-pool/providers/github-provider'
          service_account: 'github-deployer@scenehunter-29ff8.iam.gserviceaccount.com'

      # 3. Устанавливаем Node.js
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # 4. Устанавливаем зависимости
      - name: Install Dependencies
        run: npm install

      # 5. Создаем .env файл для сборки
      - name: Create .env file
        run: |
          echo "NEXT_PUBLIC_FIREBASE_API_KEY=${{ secrets.NEXT_PUBLIC_FIREBASE_API_KEY }}" >> .env
          echo "NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN=${{ secrets.NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN }}" >> .env
          echo "NEXT_PUBLIC_FIREBASE_PROJECT_ID=${{ secrets.NEXT_PUBLIC_FIREBASE_PROJECT_ID }}" >> .env
          echo "NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET=${{ secrets.NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET }}" >> .env
          echo "NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID=${{ secrets.NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID }}" >> .env
          echo "NEXT_PUBLIC_FIREBASE_APP_ID=${{ secrets.NEXT_PUBLIC_FIREBASE_APP_ID }}" >> .env
          echo "GEMINI_API_KEY=${{ secrets.GEMINI_API_KEY }}" >> .env
      
      # 6. Устанавливаем Firebase CLI
      - name: Install Firebase CLI
        run: npm install -g firebase-tools

      # 7. Собираем проект
      - name: Build Project
        run: npm run build

      # 8. Деплоим в Firebase
      - name: Deploy to Firebase Hosting
        run: firebase deploy --only hosting --project scenehunter-29ff8